<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: http://localhost:3001 https://via.placeholder.com; font-src 'self' data:; connect-src 'self' http://localhost:3001;">
    <title>CSP修复测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-item { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .test-image { max-width: 200px; max-height: 200px; margin: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>CSP修复测试</h1>
    <p>测试不同来源的图片是否能正常加载</p>
    
    <div class="test-item">
        <h3>测试1: 本地API图片 (http://localhost:3001)</h3>
        <img src="http://localhost:3001/api/products/601101182245999/image/1758129111250_5j03v6dl9.jpg" 
             alt="本地API图片" 
             class="test-image"
             onload="console.log('本地API图片加载成功')"
             onerror="console.error('本地API图片加载失败')">
        <p>如果看到图片，说明CSP修复成功</p>
    </div>
    
    <div class="test-item">
        <h3>测试2: 外部占位图片 (https://via.placeholder.com)</h3>
        <img src="https://via.placeholder.com/200x150/4CAF50/white?text=测试图片" 
             alt="外部占位图片" 
             class="test-image"
             onload="console.log('外部占位图片加载成功')"
             onerror="console.error('外部占位图片加载失败')">
        <p>如果看到图片，说明外部图片加载正常</p>
    </div>
    
    <div class="test-item">
        <h3>测试3: Data URL图片</h3>
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMjE5NkYzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5EYXRhIFVSTDwvdGV4dD48L3N2Zz4=" 
             alt="Data URL图片" 
             class="test-image"
             onload="console.log('Data URL图片加载成功')"
             onerror="console.error('Data URL图片加载失败')">
        <p>如果看到图片，说明Data URL图片加载正常</p>
    </div>
    
    <div class="test-item">
        <h3>测试4: 被阻止的图片 (应该失败)</h3>
        <img src="https://example.com/nonexistent-image.jpg" 
             alt="被阻止的图片" 
             class="test-image"
             onload="console.log('被阻止的图片意外加载成功')"
             onerror="console.log('被阻止的图片正确被阻止')">
        <p>这个图片应该加载失败，说明CSP安全策略正常工作</p>
    </div>
    
    <div id="console-output" style="margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
        控制台输出将显示在这里...
    </div>

    <script>
        // 捕获控制台输出
        const originalLog = console.log;
        const originalError = console.error;
        
        function addToOutput(message, type = 'log') {
            const outputDiv = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '[ERROR]' : '[LOG]';
            outputDiv.innerHTML += `${timestamp} ${prefix} ${message}<br>`;
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToOutput(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToOutput(args.join(' '), 'error');
        };
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', () => {
            console.log('CSP修复测试页面加载完成');
            console.log('当前CSP策略:', document.querySelector('meta[http-equiv="Content-Security-Policy"]').content);
        });
    </script>
</body>
</html>
