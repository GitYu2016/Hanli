<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交互式采集测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #0056CC;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .monitor-section {
            margin-bottom: 32px;
            border: 2px dashed #ccc;
            padding: 20px;
            border-radius: 8px;
        }
        .collection-progress {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            border: 1px solid #bbdefb;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #4caf50;
            transition: width 0.3s ease;
        }
        .current-item {
            font-weight: 600;
            color: #1976d2;
            margin: 10px 0;
        }
        .log-container {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            background: #f5f5f5;
            border-radius: 6px;
            padding: 10px;
        }
        .log-item {
            margin-bottom: 5px;
            font-size: 12px;
            font-family: monospace;
        }
        .log-item.info { color: #2196f3; }
        .log-item.success { color: #4caf50; }
        .log-item.error { color: #f44336; }
        .log-item.warning { color: #ff9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>交互式采集功能测试</h1>
        <p>这个页面测试新的交互式采集功能，每次只采集一个商品，用户需要点击网页上的悬浮按钮来继续下一个。</p>
        
        <button class="test-button" onclick="testInteractiveCollection()">开始交互式采集测试</button>
        <button class="test-button" onclick="clearResults()">清空结果</button>
        
        <div id="result" class="result" style="display: none;"></div>
        
        <div class="monitor-section" id="monitor-section">
            <!-- 监控卡片将在这里渲染 -->
        </div>
        
        <div id="collection-progress" class="collection-progress" style="display: none;">
            <h3>采集进度</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
            </div>
            <div class="current-item" id="current-item">准备开始...</div>
            <div id="progress-stats">已完成: 0 / 总数: 0</div>
        </div>
        
        <div id="log-container" class="log-container" style="display: none;">
            <h4>采集日志</h4>
            <div id="logs"></div>
        </div>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="../renderer/config.js"></script>
    <script src="../renderer/components/Index/MonitorCard.js"></script>

    <script>
        let testUrls = [
            {
                goodsId: '601099574975605',
                collectUrl: 'https://www.temu.com/us-zh-Hans/青松可调节开跟呼吸管脚蹼-g-601099574975605.html',
                goodsTitle: '青松可调节开跟呼吸管脚蹼'
            },
            {
                goodsId: '601099549310901',
                collectUrl: 'https://www.temu.com/us-zh-Hans/蝴蝶女士睡衣套装-g-601099549310901.html',
                goodsTitle: '蝴蝶女士睡衣套装'
            },
            {
                goodsId: '601099525339350',
                collectUrl: 'https://www.temu.com/us-zh-Hans/沙滩排球套装-g-601099525339350.html',
                goodsTitle: '沙滩排球套装'
            }
        ];

        function showResult(message, type = 'info') {
            const element = document.getElementById('result');
            element.textContent = message;
            element.style.display = 'block';
            element.className = `result ${type}`;
        }

        function clearResults() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('collection-progress').style.display = 'none';
            document.getElementById('log-container').style.display = 'none';
            document.getElementById('logs').innerHTML = '';
        }

        function addLog(level, message) {
            const logsContainer = document.getElementById('logs');
            const logItem = document.createElement('div');
            logItem.className = `log-item ${level}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${level.toUpperCase()}: ${message}`;
            logsContainer.appendChild(logItem);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function updateProgress(completed, total, currentItem) {
            const progressFill = document.getElementById('progress-fill');
            const currentItemEl = document.getElementById('current-item');
            const progressStats = document.getElementById('progress-stats');
            
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            progressFill.style.width = `${percentage}%`;
            currentItemEl.textContent = currentItem || '准备开始...';
            progressStats.textContent = `已完成: ${completed} / 总数: ${total}`;
        }

        async function testInteractiveCollection() {
            console.log('开始交互式采集测试...');
            showResult('正在初始化交互式采集测试...', 'info');
            
            // 显示进度界面
            document.getElementById('collection-progress').style.display = 'block';
            document.getElementById('log-container').style.display = 'block';
            
            addLog('info', '开始交互式采集测试');
            addLog('info', `测试商品数量: ${testUrls.length}`);
            
            // 模拟MonitorCard的采集状态
            const collectionState = {
                isRunning: true,
                isPaused: false,
                currentIndex: 0,
                total: testUrls.length,
                urls: testUrls,
                completed: 0,
                failed: 0,
                startTime: new Date(),
                logs: []
            };
            
            // 更新进度
            updateProgress(0, testUrls.length, '准备开始...');
            
            // 模拟采集过程
            for (let i = 0; i < testUrls.length; i++) {
                const url = testUrls[i];
                addLog('info', `开始采集: ${url.goodsTitle}`);
                updateProgress(i, testUrls.length, `正在采集: ${url.goodsTitle}`);
                
                // 模拟打开浏览器窗口
                addLog('info', `打开浏览器窗口: ${url.collectUrl}`);
                
                // 模拟用户交互等待
                addLog('info', '等待用户点击悬浮按钮...');
                
                // 模拟采集结果（成功或失败）
                const isSuccess = Math.random() > 0.2; // 80% 成功率
                
                if (isSuccess) {
                    collectionState.completed++;
                    addLog('success', `采集成功: ${url.goodsTitle}`);
                } else {
                    collectionState.failed++;
                    addLog('error', `采集失败: ${url.goodsTitle}`);
                }
                
                updateProgress(i + 1, testUrls.length, `已完成: ${url.goodsTitle}`);
                
                // 模拟延迟
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // 采集完成
            const stats = {
                completed: collectionState.completed,
                failed: collectionState.failed,
                total: collectionState.total,
                successRate: ((collectionState.completed / collectionState.total) * 100).toFixed(1)
            };
            
            addLog('info', `采集完成 - 成功: ${stats.completed}, 失败: ${stats.failed}, 成功率: ${stats.successRate}%`);
            showResult(`交互式采集测试完成！\n成功: ${stats.completed}\n失败: ${stats.failed}\n成功率: ${stats.successRate}%`, 'success');
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('交互式采集测试页面加载完成');
            
            // 检查MonitorCard是否可用
            if (typeof monitorCardInstance !== 'undefined') {
                console.log('MonitorCard实例可用:', monitorCardInstance);
            } else {
                console.warn('MonitorCard实例不可用');
            }
        });
    </script>
</body>
</html>
