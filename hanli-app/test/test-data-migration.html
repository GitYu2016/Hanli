<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据迁移测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin-bottom: 24px;
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
        }
        .test-button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #0056CC;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-weight: 500;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .data-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            margin-top: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }
        .old-format, .new-format {
            padding: 12px;
            border-radius: 6px;
        }
        .old-format {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        .new-format {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .format-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        .old-format .format-title {
            color: #856404;
        }
        .new-format .format-title {
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>数据迁移测试</h1>
        <p>测试从旧格式到新格式的数据迁移</p>

        <div class="test-section">
            <div class="test-title">1. 数据格式对比</div>
            <button class="test-button" onclick="showFormatComparison()">显示格式对比</button>
            <div id="comparison-status" class="status" style="display: none;"></div>
            <div id="comparison-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2. 迁移功能测试</div>
            <button class="test-button" onclick="testMigration()">测试迁移功能</button>
            <div id="migration-status" class="status" style="display: none;"></div>
            <div id="migration-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3. 数据验证测试</div>
            <button class="test-button" onclick="testValidation()">测试数据验证</button>
            <div id="validation-status" class="status" style="display: none;"></div>
            <div id="validation-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. 测试日志</div>
            <button class="test-button" onclick="clearLog()">清空日志</button>
            <div id="log-area" class="log-area"></div>
        </div>
    </div>

    <script>
        // 日志函数
        function log(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logArea.textContent += logEntry;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-area').textContent = '';
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
        }

        // 显示格式对比
        function showFormatComparison() {
            log('显示数据格式对比...');
            showStatus('comparison-status', '正在显示格式对比...', 'info');
            
            const oldFormat = {
                "goodsId": "601099514703283",
                "listingDate": "",
                "collectTime": "2025-09-18T13:05:09",
                "goodsSold": 100000,
                "goodsCat1": "家居装修",
                "goodsCat2": "焊接工具",
                "goodsCat3": "低温通用药芯焊丝家用维修神器焊接铜铁铝不锈钢空调冰箱维修焊丝",
                "skuList": [
                    {
                        "skuId": 17592204479169,
                        "skuName": "焊丝 [20包] 约259.84英寸",
                        "skuPic": "https://img.kwcdn.com/product/1e133b36f8e/d59f8b0c-f25b-4cd5-a454-fdccf60c1da8_800x800.jpeg",
                        "goodsPromoPrice": "$1.89"
                    }
                ],
                "storeId": "76928411705",
                "storeName": "Shenzhen easy point Ling",
                "storeData": {
                    "storeRating": 4.6,
                    "storeSold": 600000,
                    "storeFollowers": 1019,
                    "storeltemsNum": 52,
                    "storeStartYear": 3
                }
            };

            const newFormat = [
                {
                    "timestamp": "2025-09-18T13:05:09",
                    "goodsData": {
                        "goodsSold": 100000,
                        "goodsPromoPrice": 13.23
                    },
                    "storeData": {
                        "storeSold": 600000,
                        "storeFollowers": 1019,
                        "storeltemsNum": 52,
                        "storeRating": 4.6,
                        "storeStartYear": 2022
                    }
                }
            ];

            const resultsDiv = document.getElementById('comparison-results');
            resultsDiv.innerHTML = `
                <div class="comparison">
                    <div class="old-format">
                        <div class="format-title">旧格式（单条记录）</div>
                        <div class="data-preview">${JSON.stringify(oldFormat, null, 2)}</div>
                    </div>
                    <div class="new-format">
                        <div class="format-title">新格式（数组格式）</div>
                        <div class="data-preview">${JSON.stringify(newFormat, null, 2)}</div>
                    </div>
                </div>
            `;

            showStatus('comparison-status', '格式对比显示完成', 'success');
            log('格式对比显示完成');
        }

        // 测试迁移功能
        function testMigration() {
            log('开始测试迁移功能...');
            showStatus('migration-status', '正在测试迁移功能...', 'info');
            
            try {
                const testCases = [
                    {
                        name: '标准数据',
                        oldData: {
                            "goodsId": "601099514703283",
                            "collectTime": "2025-09-18T13:05:09",
                            "goodsSold": 100000,
                            "skuList": [{"goodsPromoPrice": "$1.89"}],
                            "storeData": {
                                "storeRating": 4.6,
                                "storeSold": 600000,
                                "storeFollowers": 1019,
                                "storeltemsNum": 52,
                                "storeStartYear": 3
                            }
                        }
                    },
                    {
                        name: '无价格数据',
                        oldData: {
                            "goodsId": "601099514703283",
                            "collectTime": "2025-09-18T13:05:09",
                            "goodsSold": 100000,
                            "skuList": [],
                            "storeData": {
                                "storeRating": 4.6,
                                "storeSold": 600000,
                                "storeFollowers": 1019,
                                "storeltemsNum": 52,
                                "storeStartYear": 5
                            }
                        }
                    }
                ];

                const results = testCases.map(testCase => {
                    const migrated = migrateOldFormat(testCase.oldData);
                    return {
                        name: testCase.name,
                        original: testCase.oldData,
                        migrated: migrated,
                        valid: validateNewFormat(migrated)
                    };
                });

                showStatus('migration-status', '迁移功能测试完成', 'success');
                log('迁移功能测试完成');
                
                const resultsDiv = document.getElementById('migration-results');
                resultsDiv.innerHTML = `
                    <h4>迁移测试结果:</h4>
                    <div class="data-preview">${JSON.stringify(results, null, 2)}</div>
                `;

            } catch (error) {
                showStatus('migration-status', `迁移功能测试失败: ${error.message}`, 'error');
                log(`迁移功能测试失败: ${error.message}`, 'error');
            }
        }

        // 测试数据验证
        function testValidation() {
            log('开始测试数据验证...');
            showStatus('validation-status', '正在测试数据验证...', 'info');
            
            const testCases = [
                {
                    name: '有效数据',
                    data: [
                        {
                            "timestamp": "2025-09-18T13:05:09",
                            "goodsData": {
                                "goodsSold": 100000,
                                "goodsPromoPrice": 13.23
                            },
                            "storeData": {
                                "storeSold": 600000,
                                "storeFollowers": 1019,
                                "storeltemsNum": 52,
                                "storeRating": 4.6,
                                "storeStartYear": 2022
                            }
                        }
                    ],
                    expected: true
                },
                {
                    name: '无效时间戳',
                    data: [
                        {
                            "timestamp": "invalid-timestamp",
                            "goodsData": {
                                "goodsSold": 100000,
                                "goodsPromoPrice": 13.23
                            },
                            "storeData": {
                                "storeSold": 600000,
                                "storeFollowers": 1019,
                                "storeltemsNum": 52,
                                "storeRating": 4.6,
                                "storeStartYear": 2022
                            }
                        }
                    ],
                    expected: false
                },
                {
                    name: '无效商品数据',
                    data: [
                        {
                            "timestamp": "2025-09-18T13:05:09",
                            "goodsData": {
                                "goodsSold": "invalid",
                                "goodsPromoPrice": 13.23
                            },
                            "storeData": {
                                "storeSold": 600000,
                                "storeFollowers": 1019,
                                "storeltemsNum": 52,
                                "storeRating": 4.6,
                                "storeStartYear": 2022
                            }
                        }
                    ],
                    expected: false
                }
            ];

            let allPassed = true;
            const results = testCases.map(testCase => {
                const isValid = validateNewFormat(testCase.data);
                const passed = isValid === testCase.expected;
                allPassed = allPassed && passed;
                
                log(`验证测试 ${testCase.name}: ${isValid} (期望: ${testCase.expected}) ${passed ? '✓' : '✗'}`);
                
                return {
                    name: testCase.name,
                    result: isValid,
                    expected: testCase.expected,
                    passed: passed
                };
            });

            if (allPassed) {
                showStatus('validation-status', '数据验证测试通过', 'success');
                log('数据验证测试通过');
            } else {
                showStatus('validation-status', '数据验证测试失败', 'error');
                log('数据验证测试失败', 'error');
            }

            const resultsDiv = document.getElementById('validation-results');
            resultsDiv.innerHTML = `
                <h4>验证测试结果:</h4>
                <div class="data-preview">${JSON.stringify(results, null, 2)}</div>
            `;
        }

        // 迁移函数
        function migrateOldFormat(oldData) {
            // 价格转换函数
            function convertPriceToCNY(priceStr) {
                if (!priceStr || typeof priceStr !== 'string') {
                    return 0;
                }
                const priceMatch = priceStr.match(/\$?(\d+(?:\.\d+)?)/);
                if (priceMatch) {
                    const usdPrice = parseFloat(priceMatch[1]);
                    const exchangeRate = 7.0;
                    return Math.round(usdPrice * exchangeRate * 100) / 100;
                }
                return 0;
            }

            // 年份转换函数
            function convertStartYear(yearsAgo) {
                if (typeof yearsAgo !== 'number') return 0;
                const currentYear = new Date().getFullYear();
                return currentYear - yearsAgo;
            }

            const goodsPromoPrice = oldData.skuList && oldData.skuList.length > 0 
                ? convertPriceToCNY(oldData.skuList[0].goodsPromoPrice)
                : 0;

            return [
                {
                    timestamp: oldData.collectTime || new Date().toISOString(),
                    goodsData: {
                        goodsSold: oldData.goodsSold || 0,
                        goodsPromoPrice: goodsPromoPrice
                    },
                    storeData: {
                        storeSold: oldData.storeData?.storeSold || 0,
                        storeFollowers: oldData.storeData?.storeFollowers || 0,
                        storeltemsNum: oldData.storeData?.storeltemsNum || 0,
                        storeRating: oldData.storeData?.storeRating || 0,
                        storeStartYear: convertStartYear(oldData.storeData?.storeStartYear)
                    }
                }
            ];
        }

        // 验证新格式数据
        function validateNewFormat(data) {
            if (!Array.isArray(data)) return false;
            
            for (const item of data) {
                // 验证时间戳格式
                const timestampRegex = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/;
                if (!timestampRegex.test(item.timestamp)) return false;
                
                // 验证商品数据
                if (typeof item.goodsData?.goodsSold !== 'number' || 
                    typeof item.goodsData?.goodsPromoPrice !== 'number') return false;
                
                // 验证店铺数据
                const storeData = item.storeData;
                if (typeof storeData?.storeSold !== 'number' || 
                    typeof storeData?.storeFollowers !== 'number' || 
                    typeof storeData?.storeltemsNum !== 'number' || 
                    typeof storeData?.storeRating !== 'number' ||
                    typeof storeData?.storeStartYear !== 'number') return false;
            }
            
            return true;
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', () => {
            log('数据迁移测试页面已加载');
        });
    </script>
</body>
</html>
