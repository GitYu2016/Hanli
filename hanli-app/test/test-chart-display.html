<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图表显示测试</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.2s;
        }
        .btn:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
        }
        .chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .chart-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .chart-item h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>图表显示测试</h1>
        <p>测试ProductCharts组件是否能正确显示图表</p>
        
        <div class="btn" onclick="testChartDisplay()">测试图表显示</div>
        <div class="btn" onclick="testWithRealData()">使用真实数据测试</div>
        <div class="btn" onclick="clearLogs()">清空日志</div>
        
        <div id="status"></div>
        <div id="log" class="log"></div>
        
        <div class="chart-container">
            <div class="chart-item">
                <h3>销量图表</h3>
                <div class="chart-wrapper">
                    <canvas id="sales-chart" width="400" height="300"></canvas>
                </div>
            </div>
            <div class="chart-item">
                <h3>价格图表</h3>
                <div class="chart-wrapper">
                    <canvas id="price-chart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 模拟ProductCharts组件
        class ProductCharts {
            constructor() {
                this.salesChart = null;
                this.priceChart = null;
                this.chartData = null;
            }

            renderCharts(product, monitoringData) {
                log('ProductCharts.renderCharts 被调用:', {
                    productId: product?.goodsId,
                    hasMonitoringData: !!monitoringData,
                    monitoringDataType: Array.isArray(monitoringData) ? 'array' : typeof monitoringData
                });
                
                // 检查Chart.js是否已加载
                if (typeof Chart === 'undefined') {
                    log('Chart.js未加载，无法显示图表', 'error');
                    return;
                }

                try {
                    // 处理图表数据
                    log('开始处理图表数据');
                    this.chartData = this.processChartData(product, monitoringData);
                    log('图表数据处理完成:', this.chartData);
                    
                    // 渲染各个图表
                    log('开始渲染销量图表');
                    this.renderSalesChart();
                    log('开始渲染价格图表');
                    this.renderPriceChart();
                    
                    log('图表渲染完成', 'success');
                } catch (error) {
                    log('图表渲染失败: ' + error.message, 'error');
                }
            }

            processChartData(product, monitoringData) {
                log('处理图表数据:', product?.goodsId, monitoringData);
                
                // 如果没有监控数据，使用产品基本信息生成单日数据
                if (!monitoringData) {
                    return this.generateSingleDayData(product, monitoringData);
                }

                // 处理不同的监控数据格式
                let trendData = null;
                
                // 如果是数组格式（monitoring.json的直接格式）
                if (Array.isArray(monitoringData)) {
                    trendData = monitoringData;
                }
                // 如果是对象格式，检查是否有trendData字段
                else if (monitoringData.trendData && Array.isArray(monitoringData.trendData)) {
                    trendData = monitoringData.trendData;
                }
                // 如果是单个监控记录对象
                else if (monitoringData.goodsData) {
                    trendData = [monitoringData];
                }

                // 如果没有有效的趋势数据，使用产品基本信息生成单日数据
                if (!trendData || trendData.length === 0) {
                    return this.generateSingleDayData(product, monitoringData);
                }

                const labels = [];
                const sales = [];
                const promoPrice = [];
                const normalPrice = [];

                // 处理趋势数据
                trendData.forEach((item, index) => {
                    // 生成日期标签
                    const date = new Date();
                    date.setDate(date.getDate() - (trendData.length - 1 - index));
                    labels.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));

                    // 销量数据 - 从goodsData中获取goodsSold字段
                    let goodsSold = 0;
                    if (item.goodsData && item.goodsData.goodsSold) {
                        goodsSold = this.parseNumber(item.goodsData.goodsSold);
                    } else if (item.goodsSold) {
                        goodsSold = this.parseNumber(item.goodsSold);
                    }
                    sales.push(Math.round(goodsSold));

                    // 价格数据 - 从goodsData中获取价格字段
                    let promoPriceValue = 0;
                    let normalPriceValue = 0;
                    
                    if (item.goodsData) {
                        promoPriceValue = this.parsePrice(item.goodsData.goodsPromoPrice) || 0;
                        normalPriceValue = this.parsePrice(item.goodsData.goodsNormalPrice) || 0;
                    } else {
                        promoPriceValue = this.parsePrice(item.goodsPromoPrice) || 0;
                        normalPriceValue = this.parsePrice(item.goodsNormalPrice) || 0;
                    }
                    
                    promoPrice.push(promoPriceValue);
                    normalPrice.push(normalPriceValue);
                });

                return {
                    labels,
                    sales,
                    promoPrice,
                    normalPrice
                };
            }

            generateSingleDayData(product, monitoringData) {
                const today = new Date();
                const labels = [today.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })];
                
                // 从监控数据中获取销量，确保为整数
                const sales = monitoringData ? Math.round(monitoringData.goodsSold || 0) : 0;
                
                // 从产品数据中获取价格
                let promoPrice = 0;
                let normalPrice = 0;
                
                if (product.skuList && product.skuList.length > 0) {
                    const sku = product.skuList[0];
                    promoPrice = this.parsePrice(sku.goodsPromoPrice) || 0;
                    normalPrice = this.parsePrice(sku.goodsNormalPrice) || 0;
                }
                
                return {
                    labels,
                    sales: [sales],
                    promoPrice: [promoPrice],
                    normalPrice: [normalPrice]
                };
            }

            parsePrice(priceStr) {
                if (!priceStr) return 0;
                
                // 移除货币符号和空格，提取数字
                const match = priceStr.toString().match(/[\d.]+/);
                return match ? parseFloat(match[0]) : 0;
            }

            parseNumber(numStr) {
                if (!numStr) return 0;
                
                // 提取数字部分
                const match = numStr.toString().match(/[\d,]+/);
                if (match) {
                    // 移除逗号并转换为数字
                    return parseFloat(match[0].replace(/,/g, ''));
                }
                return 0;
            }

            renderSalesChart() {
                const ctx = document.getElementById('sales-chart');
                if (!ctx) {
                    log('销量图表canvas元素未找到', 'error');
                    return;
                }

                // 销毁已存在的图表
                if (this.salesChart) {
                    this.salesChart.destroy();
                }

                this.salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: this.chartData.labels,
                        datasets: [{
                            label: '销量',
                            data: this.chartData.sales,
                            borderColor: 'rgba(0, 123, 255, 0.8)',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointStyle: 'circle'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `销量: ${context.parsed.y}件`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    stepSize: Math.max(1, Math.ceil(this.chartData.sales.reduce((a, b) => Math.max(a, b), 0) / 10)),
                                    callback: function(value) {
                                        return Math.round(value) + '件';
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            }

            renderPriceChart() {
                const ctx = document.getElementById('price-chart');
                if (!ctx) {
                    log('价格图表canvas元素未找到', 'error');
                    return;
                }

                // 销毁已存在的图表
                if (this.priceChart) {
                    this.priceChart.destroy();
                }

                this.priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: this.chartData.labels,
                        datasets: [{
                            label: '促销价格',
                            data: this.chartData.promoPrice,
                            borderColor: 'rgba(255, 99, 132, 0.8)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointStyle: 'circle'
                        }, {
                            label: '正常价格',
                            data: this.chartData.normalPrice,
                            borderColor: 'rgba(54, 162, 235, 0.8)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointStyle: 'circle'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ¥${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    stepSize: Math.max(1, Math.ceil(Math.max(...this.chartData.promoPrice, ...this.chartData.normalPrice) / 10)),
                                    callback: function(value) {
                                        return '¥' + Math.round(value);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
        }

        let productCharts = null;

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.className = type;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearLogs() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('status').innerHTML = '';
        }

        function testChartDisplay() {
            log('开始测试图表显示');
            
            // 创建测试数据
            const testProduct = {
                goodsId: '601099537814729',
                skuList: [{
                    goodsPromoPrice: '¥52.29',
                    goodsNormalPrice: '¥65.00'
                }]
            };

            const testMonitoringData = [
                {
                    "id": "1758216357768",
                    "utcTime": "2025-09-18T17:25:57.768+08:00",
                    "goodsData": {
                        "goodsSold": "72000件",
                        "goodsPromoPrice": "¥52.29",
                        "goodsTitle": "3pcs美丽的悬挂蜂鸟喂食器，金属瓶蜂鸟喂食器，带圆形金属框架和栖息处",
                        "goodsRating": "0",
                        "goodsReviews": "0条评价"
                    },
                    "storeData": {
                        "storeSold": "100000件",
                        "storeFollowers": "231人关注",
                        "storeItemsNum": "11个商品",
                        "storeRating": "4.6",
                        "storeName": "Petsandlights"
                    }
                }
            ];

            // 创建图表组件
            productCharts = new ProductCharts();
            
            // 渲染图表
            productCharts.renderCharts(testProduct, testMonitoringData);
            
            showStatus('图表测试完成', 'success');
        }

        function testWithRealData() {
            log('开始使用真实数据测试');
            
            // 模拟从API获取数据
            fetch('http://localhost:3001/api/products/601099537814729/monitoring')
                .then(response => {
                    log('API响应状态: ' + response.status);
                    return response.json();
                })
                .then(data => {
                    log('API返回数据: ' + JSON.stringify(data));
                    
                    if (data.success && data.monitoring) {
                        const testProduct = {
                            goodsId: '601099537814729',
                            skuList: [{
                                goodsPromoPrice: '¥52.29',
                                goodsNormalPrice: '¥65.00'
                            }]
                        };
                        
                        productCharts = new ProductCharts();
                        productCharts.renderCharts(testProduct, data.monitoring);
                        
                        showStatus('真实数据测试完成', 'success');
                    } else {
                        showStatus('API返回数据格式不正确', 'error');
                    }
                })
                .catch(error => {
                    log('API请求失败: ' + error.message, 'error');
                    showStatus('API请求失败', 'error');
                });
        }

        // 页面加载完成后的初始化
        window.addEventListener('load', function() {
            log('页面加载完成');
            log('Chart.js版本: ' + (typeof Chart !== 'undefined' ? Chart.version : '未加载'));
        });
    </script>
</body>
</html>
