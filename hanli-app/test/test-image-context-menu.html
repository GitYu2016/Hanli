<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片右键菜单测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .image-item {
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .image-item:hover {
            border-color: #007bff;
        }
        
        .image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .image-info {
            padding: 8px;
            font-size: 12px;
        }
        
        .image-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .image-path {
            color: #666;
            word-break: break-all;
        }
        
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 150px;
        }
        
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-item:hover {
            background: #f5f5f5;
        }
        
        .hidden {
            display: none;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 5px;
        }
        
        .log-error {
            color: #dc3545;
        }
        
        .log-success {
            color: #28a745;
        }
        
        .log-warning {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>图片右键菜单功能测试</h1>
        
        <div class="test-section">
            <div class="test-title">测试说明</div>
            <p>右键点击下面的图片，测试"在 Finder 中显示"和"另存为"功能。</p>
            <p><strong>注意：</strong>这些是模拟的图片数据，实际文件可能不存在。</p>
        </div>
        
        <div class="test-section">
            <div class="test-title">模拟图片数据</div>
            <div class="image-grid" id="image-grid">
                <!-- 图片将通过JavaScript动态生成 -->
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">操作日志</div>
            <div class="log" id="log-container">
                <div class="log-entry">等待操作...</div>
            </div>
        </div>
    </div>

    <script>
        // 模拟图片数据
        const mockImages = [
            {
                name: "product_image_1.jpg",
                url: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9vTwvdGV4dD48L3N2Zz4=",
                path: "hanli-app/data/goods-library/601099514703283/product_image_1.jpg",
                size: 1024000
            },
            {
                name: "product_image_2.png",
                url: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9vTwvdGV4dD48L3N2Zz4=",
                path: "hanli-app/data/goods-library/601099514703283/product_image_2.png",
                size: 2048000
            },
            {
                name: "product_image_3.jpeg",
                url: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjYmJiIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9vTwvdGV4dD48L3N2Zz4=",
                path: "hanli-app/data/goods-library/601099514703283/product_image_3.jpeg",
                size: 1536000
            },
            {
                name: "network_image.jpg",
                url: "https://example.com/image.jpg",
                path: null,
                size: 512000
            }
        ];

        // 模拟ImageSelection组件
        class MockImageSelection {
            constructor() {
                this.images = mockImages;
                this.goodsId = "601099514703283";
            }

            showContextMenu(event, index, fileName, filePath) {
                event.preventDefault();
                this.hideContextMenu();
                
                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.id = 'image-context-menu';
                
                const platform = navigator.platform.toLowerCase();
                const showInFinderText = platform.includes('mac') ? '在 Finder 中显示' : '在文件夹中显示';
                
                contextMenu.innerHTML = `
                    <div class="context-menu-item" onclick="mockImageSelection.showInFinder(${index}, '${fileName}', '${filePath}')">
                        <span>${showInFinderText}</span>
                    </div>
                    <div class="context-menu-item" onclick="mockImageSelection.saveAs(${index}, '${fileName}', '${filePath}')">
                        <span>另存为</span>
                    </div>
                `;
                
                contextMenu.style.left = event.clientX + 'px';
                contextMenu.style.top = event.clientY + 'px';
                
                document.body.appendChild(contextMenu);
                
                setTimeout(() => {
                    document.addEventListener('click', this.hideContextMenu.bind(this), { once: true });
                }, 0);
            }

            hideContextMenu() {
                const contextMenu = document.getElementById('image-context-menu');
                if (contextMenu) {
                    contextMenu.remove();
                }
            }

            async showInFinder(index, fileName, filePath) {
                this.log(`尝试显示文件: ${fileName}`, 'info');
                this.log(`文件路径: ${filePath}`, 'info');
                
                try {
                    let fullPath = filePath;
                    
                    if (!fullPath && this.images && this.images[index]) {
                        const image = this.images[index];
                        if (image.path) {
                            fullPath = image.path;
                        } else if (image.url && image.url.startsWith('file://')) {
                            fullPath = image.url.replace('file://', '');
                        } else if (image.url) {
                            this.log('图片URL是HTTP链接，无法在本地文件系统中显示', 'warning');
                            alert('无法在本地文件系统中显示网络图片');
                            return;
                        }
                    }
                    
                    if (!fullPath) {
                        let goodsId = this.goodsId;
                        if (goodsId && fileName) {
                            fullPath = `hanli-app/data/goods-library/${goodsId}/${fileName}`;
                            this.log(`尝试构建的路径: ${fullPath}`, 'info');
                        }
                    }
                    
                    if (!fullPath) {
                        this.log('无法确定文件路径', 'error');
                        alert('无法确定文件路径，请检查文件是否存在');
                        return;
                    }
                    
                    this.log(`准备显示文件: ${fullPath}`, 'info');
                    
                    // 模拟API调用
                    if (window.electronAPI && window.electronAPI.fileAPI) {
                        const result = await window.electronAPI.fileAPI.showInFinder(fullPath);
                        if (result.success) {
                            this.log('文件已在 Finder/文件夹中显示', 'success');
                        } else {
                            this.log(`显示文件失败: ${result.error}`, 'error');
                            alert('显示文件失败: ' + result.error);
                        }
                    } else {
                        this.log('Electron API 不可用，这是模拟测试', 'warning');
                        alert('这是模拟测试，Electron API 不可用');
                    }
                } catch (error) {
                    this.log(`显示文件失败: ${error.message}`, 'error');
                    alert('显示文件失败: ' + error.message);
                } finally {
                    this.hideContextMenu();
                }
            }

            async saveAs(index, fileName, filePath) {
                this.log(`尝试另存为文件: ${fileName}`, 'info');
                this.log(`文件路径: ${filePath}`, 'info');
                
                try {
                    let fullPath = filePath;
                    
                    if (!fullPath && this.images && this.images[index]) {
                        const image = this.images[index];
                        if (image.path) {
                            fullPath = image.path;
                        } else if (image.url && image.url.startsWith('file://')) {
                            fullPath = image.url.replace('file://', '');
                        } else if (image.url) {
                            this.log('图片URL是HTTP链接，无法另存为本地文件', 'warning');
                            alert('无法另存为网络图片');
                            return;
                        }
                    }
                    
                    if (!fullPath) {
                        let goodsId = this.goodsId;
                        if (goodsId && fileName) {
                            fullPath = `hanli-app/data/goods-library/${goodsId}/${fileName}`;
                            this.log(`尝试构建的路径: ${fullPath}`, 'info');
                        }
                    }
                    
                    if (!fullPath) {
                        this.log('无法确定文件路径', 'error');
                        alert('无法确定文件路径，请检查文件是否存在');
                        return;
                    }
                    
                    this.log(`准备另存为文件: ${fullPath}`, 'info');
                    
                    // 模拟API调用
                    if (window.electronAPI && window.electronAPI.fileAPI) {
                        const result = await window.electronAPI.fileAPI.saveAs(fullPath, fileName);
                        if (result.success) {
                            this.log('文件另存为成功', 'success');
                            alert('文件另存为成功');
                        } else {
                            this.log(`另存为失败: ${result.error}`, 'error');
                            alert('另存为失败: ' + result.error);
                        }
                    } else {
                        this.log('Electron API 不可用，这是模拟测试', 'warning');
                        alert('这是模拟测试，Electron API 不可用');
                    }
                } catch (error) {
                    this.log(`另存为失败: ${error.message}`, 'error');
                    alert('另存为失败: ' + error.message);
                } finally {
                    this.hideContextMenu();
                }
            }

            log(message, type = 'info') {
                const logContainer = document.getElementById('log-container');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            render() {
                const grid = document.getElementById('image-grid');
                let html = '';
                
                this.images.forEach((image, index) => {
                    const fileName = image.name;
                    const fileSize = this.formatFileSize(image.size);
                    
                    html += `
                        <div class="image-item" 
                             oncontextmenu="mockImageSelection.showContextMenu(event, ${index}, '${fileName}', '${image.path || ''}')"
                             data-file-name="${fileName}"
                             data-file-path="${image.path || ''}">
                            <img src="${image.url}" alt="${fileName}">
                            <div class="image-info">
                                <div class="image-name">${fileName}</div>
                                <div class="image-path">${image.path || '无路径信息'}</div>
                            </div>
                        </div>
                    `;
                });
                
                grid.innerHTML = html;
            }
        }

        // 初始化
        const mockImageSelection = new MockImageSelection();
        mockImageSelection.render();
        mockImageSelection.log('图片右键菜单测试页面已加载', 'success');
        mockImageSelection.log('右键点击图片测试功能', 'info');
    </script>
</body>
</html>
