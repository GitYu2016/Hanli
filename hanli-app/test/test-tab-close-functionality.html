<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tab关闭功能测试</title>
    <link rel="stylesheet" href="../renderer/styles.css">
    <link rel="stylesheet" href="../renderer/theme/light/colors.css">
    <link rel="stylesheet" href="../renderer/icons-fixed.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--color-background);
            color: var(--color-foreground);
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            background-color: var(--color-card-background);
            border-radius: 12px;
            border: 1px solid var(--color-border);
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--color-text-primary);
        }
        
        .tab-demo {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .test-info {
            background-color: var(--color-input-background);
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 10px;
        }
        
        .test-info strong {
            color: var(--color-text-primary);
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background-color: var(--color-hover);
        }
        
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-primary-foreground);
            border-color: var(--color-primary);
        }
        
        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Tab关闭功能测试</h1>
        
        <div class="test-section">
            <div class="test-title">Tab关闭测试</div>
            <div class="tab-demo" id="tab-demo">
                <!-- Tab将通过JavaScript动态生成 -->
            </div>
            
            <div style="margin-bottom: 16px;">
                <button class="btn btn-primary" onclick="addTestTab()">添加测试Tab</button>
                <button class="btn" onclick="clearAllTabs()">清空所有Tab</button>
            </div>
            
            <div class="test-info">
                <strong>测试说明：</strong><br>
                1. 悬浮在Tab上，关闭按钮会显示<br>
                2. 点击关闭按钮（❌）可以关闭Tab<br>
                3. 关闭当前活动Tab时，会自动切换到其他Tab<br>
                4. 关闭动画：Tab会缩放并淡出<br>
                5. 快捷键：Ctrl+W 可以关闭当前活动Tab
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">操作日志</div>
            <div id="log-container" class="test-info" style="max-height: 200px; overflow-y: auto;">
                等待操作...
            </div>
        </div>
    </div>
    
    <script>
        // 模拟TabManager类
        class TestTabManager {
            constructor() {
                this.tabs = [];
                this.activeTabId = null;
                this.nextTabId = 1;
                this.init();
            }
            
            init() {
                // 添加初始Tab
                this.addTab('home', '首页', 'ph-house');
                this.addTab('products', '产品库', 'ph-package');
            }
            
            addTab(pageType, title, iconClass) {
                const tab = {
                    id: `tab-${this.nextTabId++}`,
                    pageType: pageType,
                    title: title,
                    iconClass: iconClass,
                    isActive: false
                };
                
                this.tabs.push(tab);
                if (!this.activeTabId) {
                    this.setActiveTab(tab.id);
                }
                this.renderTabs();
                this.log(`添加Tab: ${title}`);
            }
            
            setActiveTab(tabId) {
                this.tabs.forEach(tab => tab.isActive = false);
                const tab = this.tabs.find(t => t.id === tabId);
                if (tab) {
                    tab.isActive = true;
                    this.activeTabId = tabId;
                }
            }
            
            getActiveTab() {
                return this.tabs.find(tab => tab.isActive);
            }
            
            closeTab(tabId) {
                const tabIndex = this.tabs.findIndex(tab => tab.id === tabId);
                if (tabIndex === -1) return;
                
                const tab = this.tabs[tabIndex];
                const isActiveTab = tab.isActive;
                
                this.log(`关闭Tab: ${tab.title}`);
                
                // 添加关闭动画
                const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (tabElement) {
                    tabElement.style.transform = 'scale(0.8)';
                    tabElement.style.opacity = '0';
                    
                    setTimeout(() => {
                        this.tabs.splice(tabIndex, 1);
                        
                        // 如果关闭的是活动Tab，需要选择新的活动Tab
                        if (isActiveTab && this.tabs.length > 0) {
                            let newActiveIndex = tabIndex - 1;
                            if (newActiveIndex < 0) {
                                newActiveIndex = 0;
                            }
                            this.setActiveTab(this.tabs[newActiveIndex].id);
                            this.log(`切换到Tab: ${this.tabs[newActiveIndex].title}`);
                        } else if (this.tabs.length === 0) {
                            this.activeTabId = null;
                            this.log('所有Tab已关闭');
                        }
                        
                        this.renderTabs();
                    }, 200);
                }
            }
            
            renderTabs() {
                const container = document.getElementById('tab-demo');
                container.innerHTML = '';
                
                this.tabs.forEach(tab => {
                    const tabDiv = document.createElement('div');
                    tabDiv.className = `tab ${tab.isActive ? 'active' : ''}`;
                    tabDiv.setAttribute('data-tab-id', tab.id);
                    
                    const icon = `<i class="ph ${tab.iconClass}"></i>`;
                    
                    tabDiv.innerHTML = `
                        <div class="tab-icon">${icon}</div>
                        <div class="tab-text">${tab.title}</div>
                        <div class="tab-close">
                            <i class="ph ph-x"></i>
                        </div>
                    `;
                    
                    // 添加点击事件
                    tabDiv.addEventListener('click', (e) => {
                        // 检查是否点击了关闭按钮或其子元素
                        if (e.target.closest('.tab-close')) {
                            e.stopPropagation();
                            this.closeTab(tab.id);
                        } else {
                            this.setActiveTab(tab.id);
                            this.renderTabs();
                            this.log(`激活Tab: ${tab.title}`);
                        }
                    });
                    
                    container.appendChild(tabDiv);
                });
            }
            
            log(message) {
                const logContainer = document.getElementById('log-container');
                const time = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${time}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }
        
        // 全局变量
        let tabManager;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            tabManager = new TestTabManager();
            
            // 绑定键盘快捷键
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'w') {
                    e.preventDefault();
                    const activeTab = tabManager.getActiveTab();
                    if (activeTab) {
                        tabManager.closeTab(activeTab.id);
                    }
                }
            });
        });
        
        // 全局函数
        function addTestTab() {
            const testTabs = [
                { pageType: 'settings', title: '设置', iconClass: 'ph-gear' },
                { pageType: 'about', title: '关于', iconClass: 'ph-info' },
                { pageType: 'help', title: '帮助', iconClass: 'ph-question' },
                { pageType: 'contact', title: '联系我们', iconClass: 'ph-envelope' }
            ];
            
            const randomTab = testTabs[Math.floor(Math.random() * testTabs.length)];
            tabManager.addTab(randomTab.pageType, randomTab.title, randomTab.iconClass);
        }
        
        function clearAllTabs() {
            tabManager.tabs.forEach(tab => {
                const tabElement = document.querySelector(`[data-tab-id="${tab.id}"]`);
                if (tabElement) {
                    tabElement.remove();
                }
            });
            tabManager.tabs = [];
            tabManager.activeTabId = null;
            tabManager.log('清空所有Tab');
        }
    </script>
</body>
</html>
