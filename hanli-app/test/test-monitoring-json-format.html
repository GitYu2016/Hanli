<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>monitoring.json格式验证</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        .btn.danger {
            background: #dc3545;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px;
            display: inline-block;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .example {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .validation-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .validation-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .validation-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>monitoring.json格式验证</h1>
        
        <div>
            <h3>标准格式示例</h3>
            <div class="example" id="format-example"></div>
        </div>
        
        <div>
            <h3>格式验证</h3>
            <button class="btn" onclick="testValidFormat()">测试有效格式</button>
            <button class="btn warning" onclick="testInvalidFormat()">测试无效格式</button>
            <button class="btn success" onclick="testRealData()">测试真实数据</button>
            <button class="btn danger" onclick="clearLog()">清空日志</button>
        </div>
        
        <div>
            <h3>验证结果</h3>
            <div id="validation-result"></div>
        </div>
        
        <div>
            <h3>测试日志</h3>
            <div class="log" id="test-log"></div>
        </div>
    </div>
    
    <script>
        // 标准monitoring.json格式示例
        const standardFormat = [
            {
                "id": "1758177484167",
                "utcTime": "2025-01-20T10:30:00+08:00",
                "goodsData": {
                    "goodsSold": "1054件",
                    "goodsPromoPrice": "¥1.89",
                    "goodsTitle": "商品标题",
                    "goodsRating": "4.5",
                    "goodsReviews": "128条评价"
                },
                "storeData": {
                    "storeSold": "600000件",
                    "storeFollowers": "1019人关注",
                    "storeItemsNum": "53个商品",
                    "storeRating": "4.6",
                    "storeName": "店铺名称"
                }
            },
            {
                "id": "1758177484166",
                "utcTime": "2025-01-20T09:15:00+08:00",
                "goodsData": {
                    "goodsSold": "1023件",
                    "goodsPromoPrice": "¥1.99",
                    "goodsTitle": "商品标题",
                    "goodsRating": "4.4",
                    "goodsReviews": "125条评价"
                },
                "storeData": {
                    "storeSold": "598000件",
                    "storeFollowers": "1018人关注",
                    "storeItemsNum": "52个商品",
                    "storeRating": "4.5",
                    "storeName": "店铺名称"
                }
            }
        ];

        // 显示标准格式示例
        document.getElementById('format-example').textContent = JSON.stringify(standardFormat, null, 2);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="log-entry"><span class="log-timestamp">[${timestamp}]</span> <span class="log-${typeClass}">${message}</span></div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showValidationResult(message, isSuccess) {
            const resultDiv = document.getElementById('validation-result');
            resultDiv.innerHTML = `<div class="validation-result ${isSuccess ? 'validation-success' : 'validation-error'}">${message}</div>`;
        }

        function validateMonitoringJson(data) {
            const errors = [];
            
            // 检查是否为数组
            if (!Array.isArray(data)) {
                errors.push('monitoring.json必须是数组格式');
                return { valid: false, errors };
            }
            
            // 检查数组长度
            if (data.length > 100) {
                errors.push('数组长度不能超过100条记录');
            }
            
            // 检查每个条目
            data.forEach((entry, index) => {
                // 检查必需字段
                const requiredFields = ['id', 'utcTime', 'goodsData', 'storeData'];
                requiredFields.forEach(field => {
                    if (!(field in entry)) {
                        errors.push(`条目${index}: 缺少必需字段 "${field}"`);
                    }
                });
                
                // 检查id字段
                if (entry.id && typeof entry.id !== 'string') {
                    errors.push(`条目${index}: id字段必须是字符串`);
                }
                
                // 检查utcTime字段
                if (entry.utcTime) {
                    const timeRegex = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\+\d{2}:\d{2}$/;
                    if (!timeRegex.test(entry.utcTime)) {
                        errors.push(`条目${index}: utcTime格式不正确，应为 YYYY-MM-DDTHH:mm:ss+08:00`);
                    }
                }
                
                // 检查goodsData字段
                if (entry.goodsData && typeof entry.goodsData === 'object') {
                    const goodsFields = ['goodsSold', 'goodsPromoPrice', 'goodsTitle', 'goodsRating', 'goodsReviews'];
                    goodsFields.forEach(field => {
                        if (field in entry.goodsData && typeof entry.goodsData[field] !== 'string') {
                            errors.push(`条目${index}: goodsData.${field}必须是字符串`);
                        }
                    });
                } else if (entry.goodsData) {
                    errors.push(`条目${index}: goodsData必须是对象`);
                }
                
                // 检查storeData字段
                if (entry.storeData && typeof entry.storeData === 'object') {
                    const storeFields = ['storeSold', 'storeFollowers', 'storeItemsNum', 'storeRating', 'storeName'];
                    storeFields.forEach(field => {
                        if (field in entry.storeData && typeof entry.storeData[field] !== 'string') {
                            errors.push(`条目${index}: storeData.${field}必须是字符串`);
                        }
                    });
                } else if (entry.storeData) {
                    errors.push(`条目${index}: storeData必须是对象`);
                }
            });
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }

        function testValidFormat() {
            log('测试标准格式...');
            const result = validateMonitoringJson(standardFormat);
            
            if (result.valid) {
                log('✅ 标准格式验证通过', 'success');
                showValidationResult('✅ 格式验证通过', true);
            } else {
                log('❌ 标准格式验证失败:', 'error');
                result.errors.forEach(error => log(`  - ${error}`, 'error'));
                showValidationResult('❌ 格式验证失败', false);
            }
        }

        function testInvalidFormat() {
            log('测试无效格式...');
            
            // 测试非数组格式
            const invalidData1 = {
                "id": "123",
                "utcTime": "2025-01-20T10:30:00+08:00",
                "goodsData": {},
                "storeData": {}
            };
            
            const result1 = validateMonitoringJson(invalidData1);
            log(`非数组格式验证: ${result1.valid ? '通过' : '失败'}`, result1.valid ? 'success' : 'error');
            if (!result1.valid) {
                result1.errors.forEach(error => log(`  - ${error}`, 'error'));
            }
            
            // 测试缺少字段
            const invalidData2 = [
                {
                    "id": "123",
                    "utcTime": "2025-01-20T10:30:00+08:00"
                    // 缺少goodsData和storeData
                }
            ];
            
            const result2 = validateMonitoringJson(invalidData2);
            log(`缺少字段验证: ${result2.valid ? '通过' : '失败'}`, result2.valid ? 'success' : 'error');
            if (!result2.valid) {
                result2.errors.forEach(error => log(`  - ${error}`, 'error'));
            }
            
            // 测试错误的数据类型
            const invalidData3 = [
                {
                    "id": 123, // 应该是字符串
                    "utcTime": "2025-01-20T10:30:00+08:00",
                    "goodsData": {
                        "goodsSold": 1054 // 应该是字符串
                    },
                    "storeData": {}
                }
            ];
            
            const result3 = validateMonitoringJson(invalidData3);
            log(`错误数据类型验证: ${result3.valid ? '通过' : '失败'}`, result3.valid ? 'success' : 'error');
            if (!result3.valid) {
                result3.errors.forEach(error => log(`  - ${error}`, 'error'));
            }
            
            showValidationResult('❌ 无效格式测试完成', false);
        }

        async function testRealData() {
            log('测试真实数据...');
            
            try {
                // 尝试从App获取真实数据
                const response = await fetch('http://localhost:3001/api/monitor/get-products-list');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`获取到 ${data.products.length} 个商品`, 'success');
                    
                    // 测试第一个商品的monitoring.json
                    if (data.products.length > 0) {
                        const goodsId = data.products[0].goodsId;
                        log(`测试商品 ${goodsId} 的monitoring.json...`);
                        
                        const monitoringResponse = await fetch(`http://localhost:3001/api/monitor/get-monitoring-data?goodsId=${goodsId}`);
                        
                        if (monitoringResponse.ok) {
                            const monitoringData = await monitoringResponse.json();
                            
                            if (monitoringData.success && monitoringData.monitoringData) {
                                const result = validateMonitoringJson(monitoringData.monitoringData);
                                
                                if (result.valid) {
                                    log(`✅ 商品 ${goodsId} 的monitoring.json格式正确`, 'success');
                                    log(`包含 ${monitoringData.monitoringData.length} 条记录`, 'info');
                                    showValidationResult('✅ 真实数据格式验证通过', true);
                                } else {
                                    log(`❌ 商品 ${goodsId} 的monitoring.json格式错误:`, 'error');
                                    result.errors.forEach(error => log(`  - ${error}`, 'error'));
                                    showValidationResult('❌ 真实数据格式验证失败', false);
                                }
                            } else {
                                log(`商品 ${goodsId} 没有monitoring.json文件`, 'warning');
                                showValidationResult('⚠️ 商品没有monitoring.json文件', false);
                            }
                        } else {
                            log(`获取商品 ${goodsId} 的monitoring.json失败: ${monitoringResponse.status}`, 'error');
                            showValidationResult('❌ 无法获取真实数据', false);
                        }
                    } else {
                        log('没有商品数据可测试', 'warning');
                        showValidationResult('⚠️ 没有商品数据可测试', false);
                    }
                } else {
                    log(`获取商品清单失败: ${response.status}`, 'error');
                    showValidationResult('❌ 无法连接到App', false);
                }
            } catch (error) {
                log(`测试真实数据失败: ${error.message}`, 'error');
                showValidationResult('❌ 测试失败', false);
            }
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
            document.getElementById('validation-result').innerHTML = '';
        }

        // 页面加载完成后显示格式说明
        document.addEventListener('DOMContentLoaded', function() {
            log('monitoring.json格式验证工具已加载');
            log('标准格式要求:');
            log('1. 必须是数组格式 []');
            log('2. 每个条目包含: id, utcTime, goodsData, storeData');
            log('3. 所有数据字段必须是字符串类型');
            log('4. utcTime格式: YYYY-MM-DDTHH:mm:ss+08:00');
            log('5. 数组最多100条记录');
        });
    </script>
</body>
</html>
