# 采集字段说明

## 概述

本文档详细说明了商品采集系统中各个JSON数据文件的结构和字段含义。系统采用模块化数据存储方式，将商品信息、媒体文件、监控数据分别存储，便于管理和分析。

## 数据结构更新说明

### monitoring.json 格式变更
- **旧格式**: 单次采集的对象格式，包含完整的商品和店铺信息
- **新格式**: 时间序列数组格式，专门用于收集和存储多次采集的结果
- **优势**: 支持历史数据追踪、趋势分析和数据对比

## 实现逻辑

### 1. 图片收集机制
- **即时收集**: 页面加载时立即扫描所有`<img>`标签，收集HTTP开头的图片URL
- **动态监听**: 使用`MutationObserver`监听DOM变化，捕获动态加载的图片
- **滚动触发**: 监听页面滚动事件，触发懒加载图片的收集
- **加载监听**: 监听图片`load`事件，确保所有图片都被收集

### 2. 图片源整合
- **主图片**: 从`window.rawData`中的`mainImages`字段提取商品主图
- **SKU图片**: 从商品SKU列表中的`skuPic`字段提取变体图片
- **页面图片**: 收集页面中所有可见的图片元素
- **去重处理**: 使用Set数据结构自动去除重复的图片URL

### 3. 图片筛选机制
- **尺寸检测**: 异步加载图片获取真实尺寸信息
- **范围筛选**: 设置最小/最大尺寸阈值过滤图片
- **目标尺寸**: 识别接近目标尺寸(800x800px)的高质量图片
- **容错处理**: 对加载失败的图片进行错误计数和日志记录

### 4. 数据存储结构
- **商品信息**: 存储基础商品数据和图片URL列表
- **媒体信息**: 存储图片详细尺寸、类型和筛选结果
- **监控数据**: 存储商品监控的时间序列数据，支持历史追踪和趋势分析

## 采集字段说明

### product.json (商品信息文件)

存储商品的基础信息，包括标题、分类、SKU列表、属性等详细信息。

```json
{
  "goodsId": "601099574975605",
  "itemId": "VL124384",
  "goodsCat1": "运动与户外",
  "goodsCat2": "水上运动",
  "goodsCat3": "青松可调节开跟呼吸管脚蹼 - 快速释放扣，防滑游泳鳍带稳固贴合适用于潜水、浮潜、水上运动 - 兼容鞋袜 - 尺码S/M/L/XL（男/女） - 成人浮潜装备，成人浮潜器材，水下探索，流线型设计，舒适Inspeck设计，潜水员用，柔韧材料",
  "goodsTitleEn": "青松可调节开跟呼吸管脚蹼 - 快速释放扣，防滑游泳鳍带稳固贴合适用于潜水、浮潜、水上运动 - 兼容鞋袜 - 尺码S/M/L/XL（男/女） - 成人浮潜装备，成人浮潜器材，水下探索，流线型设计，舒适Inspeck设计，潜水员用，柔韧材料",
  "goodsTitleCn": "",
  "skuList": [
    {
      "skuId": 17592445821666,
      "skuName": "白色|S/M 美国 4.5-8.5 欧元 38-42",
      "skuPic": "https://img.kwcdn.com/product/fancy/f172c8d8-a542-4b86-8960-89cbe84c78e9.jpg",
      "goodsPromoPrice": "$20.60",
      "goodsNormalPrice": "$28.13"
    }
  ],
  "goodsPropertyInfo": {
    "材质": "硅胶",
    "类型": "脚蹼",
    "适用人群": "成人",
    "用途": "潜水、浮潜",
    "颜色": "白色、黄色、灰色、天蓝色、绿色",
    "尺码": "S/M, L/XL",
    "商品编号": "VL124384",
    "产地": "China"
  },
  "collectTime": "2025-09-14T22:58:45",
  "collectUrl": "https://www.temu.com/us-zh-Hans/..."
}
```

#### 字段说明
- **goodsId**: 商品唯一标识符（12位数字字符串）
- **itemId**: 商品编号，商家内部编号（字符串）
- **goodsCat1**: 一级分类（字符串）
- **goodsCat2**: 二级分类（字符串）
- **goodsCat3**: 三级分类（字符串，通常包含详细描述）
- **goodsTitleEn**: 英文标题（字符串）
- **goodsTitleCn**: 中文标题（字符串，可能为空）
- **skuList**: SKU变体列表（数组）
  - **skuId**: SKU唯一标识符（数字）
  - **skuName**: SKU名称，包含颜色、尺寸等信息（字符串）
  - **skuPic**: SKU图片URL（字符串）
  - **goodsPromoPrice**: 促销价格（字符串，包含货币符号）
  - **goodsNormalPrice**: 正常价格（字符串，包含货币符号，可选）
- **goodsPropertyInfo**: 商品属性信息（对象，键值对形式）
- **collectTime**: 采集时间，东八区时间格式（字符串）
- **collectUrl**: 采集时的页面URL（字符串）

#### 数据结构特点
- **多语言支持**: 支持中英文标题
- **SKU变体**: 支持多种颜色、尺寸等变体
- **属性灵活**: 商品属性以键值对形式存储，支持任意属性
- **价格信息**: 同时存储促销价和正常价

### media.json (媒体文件)

存储商品相关的媒体文件信息，包括图片尺寸、类型、本地存储路径等。

```json
{
  "goodsId": "601099574975605",
  "media": [
    {
      "url": "https://img.kwcdn.com/product/fancy/f172c8d8-a542-4b86-8960-89cbe84c78e9.jpg",
      "width": 800,
      "height": 800,
      "isTargetSize": true,
      "type": "image",
      "path": null
    },
    {
      "url": "https://img.kwcdn.com/product/fancy/ef983a92-8d40-493b-8c60-69bda33861ab.jpg",
      "width": 800,
      "height": 800,
      "isTargetSize": true,
      "type": "image",
      "path": null
    }
  ]
}
```

#### 字段说明
- **goodsId**: 商品唯一标识符（12位数字字符串）
- **media**: 媒体文件数组
  - **url**: 图片/视频的完整URL地址（字符串）
  - **width**: 媒体文件宽度（数字，像素）
  - **height**: 媒体文件高度（数字，像素）
  - **isTargetSize**: 是否为目标尺寸（布尔值，800x800px为true）
  - **type**: 媒体类型（字符串，"image" 或 "video"）
  - **path**: 本地存储路径（字符串，初始为null，下载后更新为本地文件路径）

#### 数据结构特点
- **尺寸筛选**: 自动检测图片尺寸，标识是否为目标尺寸
- **类型支持**: 支持图片和视频两种媒体类型
- **本地存储**: 支持本地文件路径管理
- **去重处理**: 自动去除重复的媒体URL
- **质量标识**: 通过isTargetSize标识高质量图片

### monitoring.json (监控数据文件 - 时间序列格式)

存储商品的监控数据，采用时间序列数组格式，用于追踪销量、价格等变化趋势。

```json
[
  {
    "timestamp": "2025-09-17T19:44:22",
    "goodsData": {
      "goodsSold": 1054,
      "goodsPromoPrice": 13.23
    },
    "storeData": {
      "storeSold": 600000,
      "storeFollowers": 1019,
      "storeltemsNum": 53,
      "storeRating": 4.6,
      "storeStartYear": 2022
    }
  },
  {
    "timestamp": "2025-09-18T19:44:22",
    "goodsData": {
      "goodsSold": 1200,
      "goodsPromoPrice": 12.25
    },
    "storeData": {
      "storeSold": 605000,
      "storeFollowers": 1025,
      "storeltemsNum": 55,
      "storeRating": 4.7,
      "storeStartYear": 2022
    }
  }
]
```

#### 字段说明
- **timestamp**: 采集时间戳，格式为东八区时间 "YYYY-MM-DDTHH:mm:ss"（字符串）
- **goodsData**: 商品相关数据（对象）
  - **goodsSold**: 商品销量（数字）
  - **goodsPromoPrice**: 商品促销价格（数字，人民币，单位：元）
- **storeData**: 店铺相关数据（对象）
  - **storeSold**: 店铺总销量（数字）
  - **storeFollowers**: 店铺关注数（数字）
  - **storeltemsNum**: 店铺商品数量（数字）
  - **storeRating**: 店铺评分（数字，保留一位小数）
  - **storeStartYear**: 店铺开店年份（数字，如2022表示2022年开店）

#### 数据结构特点
- **时间序列**: 数组格式支持存储多次采集的历史数据
- **数据分离**: 商品数据和店铺数据分别存储，便于分析
- **易于扩展**: 可以轻松添加新的采集记录到数组末尾
- **趋势分析**: 支持时间维度的数据变化趋势分析
- **实时监控**: 支持定期采集和实时数据更新

## 文件关系说明

### 数据文件组织
每个商品目录包含以下文件：
```
goods-library/
├── {goodsId}/
│   ├── product.json      # 商品基础信息
│   ├── media.json        # 媒体文件信息
│   ├── monitoring.json   # 监控数据（时间序列）
│   └── *.jpg            # 下载的图片文件
```

### 文件用途
- **product.json**: 存储商品的基础信息，包括标题、分类、SKU列表、属性等
- **media.json**: 存储商品相关的媒体文件信息，包括图片尺寸、类型等
- **monitoring.json**: 存储商品的监控数据，用于追踪销量、价格等变化趋势
- **图片文件**: 下载到本地的商品图片，文件名格式为 `{timestamp}_{random}.jpg`

### 数据采集流程
1. **商品信息采集**: 从商品页面提取基础信息，生成 `product.json`
2. **媒体文件收集**: 收集页面中的图片和视频，生成 `media.json`
3. **监控数据更新**: 定期采集销量、价格等数据，追加到 `monitoring.json`
4. **图片下载**: 根据 `media.json` 中的URL下载图片到本地

### 数据一致性
- 所有文件使用相同的 `goodsId` 作为关联标识
- 时间字段统一使用东八区时间格式 "YYYY-MM-DDTHH:mm:ss"
- 价格字段包含货币符号，便于多币种支持
- 图片URL支持多种格式和尺寸参数
- ID统一使用UUID生成，12位数字格式

## 技术规范

### 数据格式规范
- **时间格式**: 统一使用东八区时间 "YYYY-MM-DDTHH:mm:ss"
- **ID格式**: 商品ID和SKU ID使用12位数字格式
- **价格格式**: 包含货币符号的字符串格式（如 "$1.89"）
- **图片URL**: 支持多种CDN和尺寸参数

### 存储规范
- **文件命名**: 使用goodsId作为目录名，JSON文件使用固定名称
- **图片存储**: 本地图片文件名格式为 `{timestamp}_{random}.jpg`
- **数据备份**: 支持数据版本控制和备份机制

### 扩展性设计
- **属性扩展**: goodsPropertyInfo支持任意键值对
- **媒体类型**: 支持图片和视频等多种媒体类型
- **监控指标**: 可根据需要添加新的监控数据字段
- **多语言**: 支持中英文标题和描述

## 使用示例

### 读取商品信息
```javascript
// 读取商品基础信息
const productData = JSON.parse(fs.readFileSync('product.json', 'utf8'));
console.log(`商品: ${productData.goodsTitleEn}`);
console.log(`分类: ${productData.goodsCat1} > ${productData.goodsCat2}`);

// 读取SKU信息
productData.skuList.forEach(sku => {
  console.log(`SKU: ${sku.skuName} - ${sku.goodsPromoPrice}`);
});
```

### 分析监控数据
```javascript
// 读取监控数据
const monitoringData = JSON.parse(fs.readFileSync('monitoring.json', 'utf8'));

// 计算销量增长
const latest = monitoringData[monitoringData.length - 1];
const previous = monitoringData[monitoringData.length - 2];
const salesGrowth = latest.goodsData.goodsSold - previous.goodsData.goodsSold;

console.log(`销量增长: ${salesGrowth}`);
```

### 处理媒体文件
```javascript
// 读取媒体信息
const mediaData = JSON.parse(fs.readFileSync('media.json', 'utf8'));

// 筛选目标尺寸图片
const targetImages = mediaData.media.filter(item => item.isTargetSize);
console.log(`找到 ${targetImages.length} 张目标尺寸图片`);
```