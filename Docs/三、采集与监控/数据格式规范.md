# 数据格式规范

## 概述

本文档详细说明了商品采集系统中数据格式的统一规范，确保数据的一致性和可维护性。

## 更新历史

- **2025-01-27**: 统一监控数据格式为数值类型，添加价格转换和单位处理规范
- **2025-01-28**: 添加API接口规范，更新数据获取方式

## 监控数据格式规范

### 基本原则

1. **数值类型统一**: 所有数值字段必须使用数字类型，便于计算和排序
2. **价格转换**: 美元价格自动转换为人民币数值（汇率7.0）
3. **单位处理**: 移除所有单位后缀，保留纯数值
4. **数据一致性**: 完整采集和仅采集监控数据使用相同的数据格式

### 字段类型规范

#### 商品数据 (goodsData)
```json
{
  "goodsData": {
    "goodsSold": 1138,           // 数字类型 - 商品销量
    "goodsPromoPrice": 99.47,    // 数字类型 - 商品价格（人民币）
    "goodsTitle": "商品标题",     // 字符串类型 - 商品标题
    "goodsRating": 0,            // 数字类型 - 商品评分
    "goodsReviews": 0            // 数字类型 - 商品评价数
  }
}
```

#### 店铺数据 (storeData)
```json
{
  "storeData": {
    "storeSold": 4827,           // 数字类型 - 店铺总销量
    "storeFollowers": 17,        // 数字类型 - 店铺关注数
    "storeItemsNum": 14,         // 数字类型 - 店铺商品数量
    "storeRating": 4.9,          // 数字类型 - 店铺评分
    "storeName": "店铺名称"       // 字符串类型 - 店铺名称
  }
}
```

### 价格转换规则

#### 转换逻辑
- **输入格式**: `"$1.99"` 或 `"$10.50"`
- **转换规则**: 美元价格 × 7.0 = 人民币价格
- **输出格式**: `13.93` 或 `73.5`（数字类型）

#### 转换示例
```javascript
// 输入: "$1.99"
// 处理: 1.99 × 7.0 = 13.93
// 输出: 13.93

// 输入: "$10.50"  
// 处理: 10.50 × 7.0 = 73.5
// 输出: 73.5
```

### 单位处理规则

#### 处理逻辑
移除所有单位后缀，保留纯数值：

| 字段 | 输入格式 | 输出格式 | 说明 |
|------|----------|----------|------|
| 销量 | `"1138件"` | `1138` | 移除"件"后缀 |
| 粉丝数 | `"17人关注"` | `17` | 移除"人关注"后缀 |
| 商品数 | `"14个商品"` | `14` | 移除"个商品"后缀 |
| 评价数 | `"0条评价"` | `0` | 移除"条评价"后缀 |

#### 处理示例
```javascript
// 销量处理
"1138件" → 1138

// 粉丝数处理  
"17人关注" → 17

// 商品数处理
"14个商品" → 14

// 评价数处理
"0条评价" → 0
```

## 数据来源规范

### API接口规范

#### 产品列表接口
- **接口地址**: `GET http://localhost:3001/api/products`
- **返回格式**: JSON
- **数据字段**: 包含所有产品基本信息和监控数据

#### 产品详情接口
- **接口地址**: `GET http://localhost:3001/api/products/{id}`
- **参数**: `id` - 产品ID
- **返回格式**: JSON
- **数据字段**: 单个产品的详细信息

#### 监控数据接口
- **接口地址**: `GET http://localhost:3001/api/products/{id}/monitoring`
- **参数**: `id` - 产品ID
- **返回格式**: JSON
- **数据字段**: 产品的监控数据

#### 产品统计接口
- **接口地址**: `GET http://localhost:3001/api/products/count`
- **返回格式**: JSON
- **数据字段**: 产品总数统计

### 数据提取路径

#### 商品数据来源
- **商品销量**: `rawData.store.goods.sideSalesTip`
- **商品价格**: `rawData.store.sku[0].normalPriceStr`
- **商品标题**: `rawData.store.goods.goodsName`
- **商品评分**: `rawData.store.goods.rating`
- **商品评价数**: `rawData.store.goods.reviewCount`

#### 店铺数据来源
- **店铺销量**: `mallData.goodsSalesNumUnit`
- **店铺粉丝**: `mallData.followerNumUnit`
- **店铺商品数**: `mallData.goodsNumUnit`
- **店铺评分**: `mallData.mallStar`
- **店铺名称**: `mallData.mallName`

### 数据提取函数

#### 数值提取函数
```javascript
function extractSoldNumeric(soldText) {
    // 处理销量文本，提取数值
    // 支持 "1.2k", "5万", "1000" 等格式
}

function convertPriceToCNY(priceStr) {
    // 将美元价格转换为人民币数值
    // 汇率: 1 USD = 7 CNY
}
```

## 文件格式规范

### monitoring.json 格式

#### 标准格式
```json
[
  {
    "id": "1758225947518",
    "utcTime": "2025-09-18T20:05:47.518+08:00",
    "goodsData": {
      "goodsSold": 1138,
      "goodsPromoPrice": 99.47,
      "goodsTitle": "商品标题",
      "goodsRating": 0,
      "goodsReviews": 0
    },
    "storeData": {
      "storeSold": 4827,
      "storeFollowers": 17,
      "storeItemsNum": 14,
      "storeRating": 4.9,
      "storeName": "店铺名称"
    }
  }
]
```

#### 字段说明
- **id**: 监控记录唯一标识符（字符串，时间戳）
- **utcTime**: 采集时间戳，ISO格式东八区时间（字符串）
- **goodsData**: 商品相关数据（对象）
- **storeData**: 店铺相关数据（对象）

## 实现规范

### 代码实现要求

#### 1. 数据提取
```javascript
// 使用统一的提取函数
const monitoringData = extractMonitoringData(rawData);

// 确保所有数值字段为数字类型
const monitoringEntry = {
    goodsData: {
        goodsSold: monitoringData.goodsData.goodsSold,        // 数字
        goodsPromoPrice: monitoringData.goodsData.goodsPromoPrice, // 数字
        goodsRating: parseFloat(rawData?.store?.goods?.rating || "0"), // 数字
        goodsReviews: rawData?.store?.goods?.reviewCount || 0  // 数字
    },
    storeData: {
        storeSold: monitoringData.storeData.storeSold,        // 数字
        storeFollowers: monitoringData.storeData.storeFollowers, // 数字
        storeItemsNum: monitoringData.storeData.storeltemsNum,   // 数字
        storeRating: monitoringData.storeData.storeRating     // 数字
    }
};
```

#### 2. 数据验证
```javascript
// 验证数值类型
function validateNumericData(data) {
    const numericFields = [
        'goodsSold', 'goodsPromoPrice', 'goodsRating', 'goodsReviews',
        'storeSold', 'storeFollowers', 'storeItemsNum', 'storeRating'
    ];
    
    for (const field of numericFields) {
        if (typeof data[field] !== 'number') {
            console.warn(`字段 ${field} 不是数字类型:`, data[field]);
        }
    }
}
```

## 兼容性说明

### 数据迁移

#### 从字符串格式迁移到数值格式
1. **识别字符串格式**: 检查字段是否包含单位后缀
2. **移除单位**: 使用正则表达式移除单位后缀
3. **转换数值**: 使用 `parseFloat()` 转换为数字
4. **验证结果**: 确保转换后的数据为有效数字

#### 迁移示例
```javascript
// 迁移前
"goodsSold": "1138件"

// 迁移后  
"goodsSold": 1138
```

## 最佳实践

### 1. 数据一致性
- 确保所有监控数据使用相同的格式
- 定期验证数据格式的正确性
- 使用统一的数据提取函数

### 2. 错误处理
- 对无效数据进行默认值处理
- 记录数据转换过程中的错误
- 提供数据格式验证功能

### 3. 性能优化
- 使用数值类型提高计算性能
- 避免重复的数据转换操作
- 缓存转换结果

## 注意事项

1. **价格精度**: 人民币价格保留两位小数
2. **数值范围**: 确保数值在合理范围内
3. **空值处理**: 对空值使用默认值0
4. **类型检查**: 定期检查数据类型的一致性

## 更新日志

- **2025-01-27**: 初始版本，统一监控数据格式为数值类型
