# 采集功能说明

## 功能概述
采集功能用于从网页中提取商品信息，并生成标准化的数据文件。

## 主要功能

### 1. 生成JSON文件
- 采集完成后自动生成包含商品信息的JSON文件
- JSON文件包含完整的商品数据结构和字段信息
- 文件格式遵循项目统一的数据规范

### 2. 唤起App
- 采集完成后自动唤起hanli-app应用程序
- 通过系统通知或直接启动App的方式实现
- 确保数据能够及时传递到主应用程序

### 3. 文件存储管理·
- **存储位置**: hanli-app的data文件夹下
- **文件夹命名**: 以goodsId命名的独立文件夹
- **文件结构**:
  ```
  hanli-app/data/
  └── {goodsId}/
      ├── data.json          # 商品数据文件
      ├── image1.jpg         # 图片文件
      ├── image2.png
      ├── video1.mp4         # 视频文件
      ├── video2.mov
      └── ...
  ```

### 4. 媒体文件下载
- **图片下载**: 自动下载商品相关的所有图片到goodsId文件夹
- **视频下载**: 自动下载商品相关的所有视频到goodsId文件夹
- **文件命名**: 保持原始文件名或按序号命名
- **格式支持**: 支持常见图片格式(jpg, png, gif, webp)和视频格式(mp4, mov, avi)

#### 4.1 媒体文件筛选机制
采集系统采用三层筛选机制，确保只下载高质量且未重复的媒体文件：

**第一层：基础去重**
- 使用Set数据结构自动去除重复URL
- 在收集阶段即时去重，避免重复处理

**第二层：尺寸筛选**
- 图片最小尺寸要求：800×800px
- 图片最大尺寸限制：10000×10000px
- 视频文件不进行尺寸筛选
- 支持最大数量限制（图片100张，视频50个）

**第三层：本地去重**
- 检查本地media.json文件中已存在的URL
- 跳过已下载的媒体文件，避免重复下载
- 支持增量更新，提高采集效率

#### 4.2 筛选流程详解
```
原始媒体URL列表
    ↓ (Set去重)
去重后的URL列表
    ↓ (尺寸检测和筛选)
符合尺寸要求的媒体文件
    ↓ (本地检查)
最终需要下载的媒体文件
    ↓ (异步下载)
保存到本地goodsId文件夹
```

#### 4.3 去重检查机制
**本地文件检查流程：**
1. 检查商品目录是否存在
2. 读取media.json文件
3. 提取已存在的媒体URL列表
4. 与待下载URL列表进行比对
5. 筛选出需要下载的新文件

**API接口：**
- 接口地址：`POST /api/check-existing-media`
- 请求参数：`{ goodsId, mediaUrls }`
- 返回结果：`{ existingUrls, existingCount, totalChecked }`

## 技术实现

### 5.1 核心架构
- **插件端**：Chrome扩展负责数据采集和媒体文件收集
- **App端**：Electron应用负责文件存储和下载管理
- **通信机制**：通过HTTP API进行插件与App间的数据交换
- **API服务**：Node.js + Express.js 提供RESTful API接口
- **数据存储**：本地文件系统 + MongoDB数据库

### 5.2 媒体文件处理技术
**收集技术：**
- 使用MutationObserver监听页面DOM变化
- 通过Image对象检测图片真实尺寸
- 使用Set数据结构进行高效去重

**筛选技术：**
- 异步尺寸检测，避免阻塞UI
- 本地文件系统检查，支持增量更新
- 多线程处理，提高处理效率

**下载技术：**
- 使用Node.js的http/https模块进行文件下载
- 支持断点续传和错误重试机制
- 实现下载进度监控和状态反馈

### 5.3 数据流程
```
网页数据 → 插件采集 → 尺寸筛选 → 本地去重 → App下载 → 文件存储
```

### 5.4 性能优化
- **内存管理**：及时清理临时数据，避免内存泄漏
- **网络优化**：添加下载间隔，防止服务器限制
- **存储优化**：智能去重，减少重复文件占用空间
- **用户体验**：实时进度反馈，详细状态提示

### 5.5 错误处理
- **网络错误**：自动重试机制，最多重试3次
- **文件错误**：跳过损坏文件，继续处理其他文件
- **系统错误**：完善的日志记录，便于问题排查
- **用户反馈**：清晰的错误提示和解决建议
