# 监控功能说明

## 功能概述

监控功能用于批量采集商品的价格、销量等监控数据，支持历史数据追踪和趋势分析。通过HTML页面和独立JavaScript模块实现自动采集功能。

## 功能流程

### 1. 插件采集并监控
- 在Temu商品页面点击插件图标
- 选择"开始采集"执行完整采集流程
- 自动生成标准格式的monitoring.json数组

### 2. 批量监控数据采集
- 在插件popup中点击"仅采集监控数据"
- 打开专门的监控数据采集页面
- **自动加载**: 页面自动加载商品清单和今日采集状态
- **智能状态**: 自动检查每个商品的今日采集状态，已采集的显示"今日已采集"
- **手动采集**: 点击每个商品的"开始采集"按钮进行单独采集
- **自动刷新**: 采集完成后自动刷新状态，无需手动操作

### 3. 网页悬浮采集
- 在Temu商品页面底部显示两个悬浮按钮
- **采集并监控**: 执行完整的数据采集流程
- **仅采集监控数据**: 只采集监控数据，快速更新monitoring.json
- **主题适配**: 根据系统主题自动调整按钮颜色
- **状态管理**: 采集期间按钮显示相应状态

### 4. 自动采集流程
- **任务管理**: 每个商品作为一个独立任务，支持手动触发
- **采集方式**: 在新标签页中打开URL，通过Chrome插件执行采集
- **数据更新**: 自动更新monitoring.json文件，支持goodsData和storeData字段
- **状态跟踪**: 实时显示任务状态（等待采集、采集中、今日已采集、失败）
- **错误处理**: 采集失败的任务会标记为失败状态，支持重新采集
- **超时机制**: 20秒超时，每3秒检查一次结果
- **自动刷新**: 监听monitoring.json更新事件，自动刷新状态

## 采集数据格式

采集的数据按照标准数组格式存储到 `monitoring.json` 文件中，新数据添加到数组开头：

```json
[
  {
    "id": "1758177484167",
    "utcTime": "2025-01-20T10:30:00+08:00",
    "goodsData": {
      "goodsSold": "1054件",
      "goodsPromoPrice": "¥1.89",
      "goodsTitle": "商品标题",
      "goodsRating": "4.5",
      "goodsReviews": "128条评价"
    },
    "storeData": {
      "storeSold": "600000件",
      "storeFollowers": "1019人关注",
      "storeItemsNum": "53个商品",
      "storeRating": "4.6",
      "storeName": "店铺名称"
    }
  },
  {
    "id": "1758177484166",
    "utcTime": "2025-01-20T09:15:00+08:00",
    "goodsData": { /* 历史数据 */ },
    "storeData": { /* 历史数据 */ }
  }
]
```

### 数据格式规范

#### 数组结构
- **格式**: 标准JSON数组 `[]`
- **排序**: 按时间倒序，最新数据在数组开头
- **限制**: 最多保存100条历史记录
- **标识**: 每个条目包含唯一ID和时间戳

#### 条目结构
- **id**: 唯一标识符，使用时间戳字符串
- **utcTime**: 采集时间，东八区ISO格式 `YYYY-MM-DDTHH:mm:ss+08:00`
- **goodsData**: 商品相关数据对象
- **storeData**: 店铺相关数据对象

#### 数据类型
- **字符串格式**: 所有数据字段均为字符串类型
- **单位包含**: 数值包含相应单位（如"件"、"人关注"、"条评价"）
- **价格格式**: 价格包含货币符号（如"¥1.89"）

### 数据字段说明

#### goodsData（商品数据）
- `goodsSold`: 商品销量（字符串，如"1054件"）
- `goodsPromoPrice`: 商品促销价格（字符串，如"¥1.89"）
- `goodsTitle`: 商品标题（字符串）
- `goodsRating`: 商品评分（字符串，如"4.5"）
- `goodsReviews`: 商品评价数量（字符串，如"128条评价"）

#### storeData（店铺数据）
- `storeSold`: 店铺总销量（字符串，如"600000件"）
- `storeFollowers`: 店铺关注者数量（字符串，如"1019人关注"）
- `storeItemsNum`: 店铺商品数量（字符串，如"53个商品"）
- `storeRating`: 店铺评分（字符串，如"4.6"）
- `storeName`: 店铺名称（字符串）

## 技术实现

### 前端组件
- **monitor-collection.html**: 监控数据采集页面（自动加载，无手动按钮）
- **monitor-collection.js**: 监控数据采集管理器，处理所有采集逻辑
- **content.js**: 网页悬浮按钮和采集逻辑
- **popup.html/popup.js**: 插件弹窗界面
- **采集状态管理**: 支持等待采集、采集中、今日已采集、失败四种状态
- **自动刷新**: 监听monitoring.json更新事件，自动刷新状态

### 后端API
- **GET /api/monitor/get-products-list**: 获取所有商品的采集URL清单
- **GET /api/monitor/get-monitoring-data**: 获取指定商品的monitoring.json数据
- **POST /api/monitor/update-monitoring-data**: 更新指定商品的monitoring.json数据
- **POST /api/save-json-files**: 保存JSON文件（包括monitoring.json）

### 采集流程

#### 插件采集并监控流程
1. **页面检测**: 在Temu商品页面点击插件图标
2. **数据采集**: 插件自动采集页面数据
3. **格式转换**: 将采集数据转换为标准数组格式
4. **文件保存**: 通过API保存monitoring.json文件

#### 网页悬浮采集流程
1. **悬浮按钮**: 在Temu商品页面底部显示两个按钮
2. **采集并监控**: 执行完整采集流程
3. **仅采集监控数据**: 只采集监控数据，快速更新
4. **主题适配**: 根据系统主题调整按钮颜色

#### 批量监控数据采集流程
1. **自动加载**: 页面打开后自动加载商品清单
2. **状态检查**: 自动检查每个商品的今日采集状态
3. **手动采集**: 点击商品"开始采集"按钮
2. **加载商品清单**: 从App后端获取所有商品URL
3. **逐个处理**: 按顺序处理每个商品任务
4. **打开新标签页**: 每个商品在新标签页中打开
5. **插件通信**: 通过localStorage与Chrome插件通信
6. **执行采集**: 插件自动检测页面并执行监控采集
7. **数据更新**: 采集结果通过API更新到monitoring.json文件
8. **关闭标签页**: 完成当前任务，自动开始下一个任务
9. **随机间隔**: 每个任务间隔2-5秒，避免请求过于频繁

### 插件通信机制
- **采集请求**: 通过localStorage发送`collectionRequest`
- **结果监听**: 监听`collectionResult_${taskId}`获取采集结果
- **超时处理**: 20秒采集超时保护，每3秒检查一次结果
- **数据格式**: 插件返回包含goodsData和storeData的采集结果

## 数据存储位置

采集的监控数据存储在：
```
data/goods-library/{goodsId}/monitoring.json
```

每个商品的监控数据以时间序列数组形式存储，支持历史数据追踪和趋势分析。

## 文件结构

```
hanli-plugin/
├── monitor-collection.html            # 监控数据采集页面
├── monitor-collection.js              # 监控数据采集管理器
├── popup.html                         # 插件弹窗界面
├── popup.js                           # 插件弹窗逻辑
├── main.js                            # 插件主协调器
├── content.js                         # 页面内容脚本
└── dataCollector.js                   # 数据采集模块

hanli-app/
├── test/
│   └── test-monitor-collection.html   # 监控采集测试页面
└── data/
    └── goods-library/
        └── {goodsId}/
            └── monitoring.json        # 监控数据文件（标准数组格式）
```

## 使用说明

### 1. 插件采集并监控
- 在Temu商品页面点击Chrome插件图标
- 点击"开始采集"按钮
- 插件自动采集数据并生成标准格式的monitoring.json

### 2. 批量监控数据采集
- 在任意页面点击Chrome插件图标
- 点击"仅采集监控数据"按钮
- 页面自动加载商品清单和今日采集状态
- 点击每个商品的"开始采集"按钮进行单独采集

### 3. 网页悬浮采集
- 在Temu商品页面底部会显示两个悬浮按钮
- **采集并监控**: 执行完整的数据采集流程
- **仅采集监控数据**: 只采集监控数据，快速更新monitoring.json
- 按钮会根据系统主题自动调整颜色

### 4. 自动刷新机制
- 采集完成后自动刷新状态，无需手动操作
- 监听monitoring.json更新事件
- 支持localStorage和postMessage两种通信方式
- **停止采集**: 完全停止采集流程
- **重置任务**: 重置所有任务状态，重新开始

## 注意事项

1. **数据格式规范**: monitoring.json必须为标准数组格式，包含id、utcTime、goodsData、storeData字段
2. **字符串类型**: 所有数据字段均为字符串类型，包含相应单位
3. **时间格式**: 使用东八区ISO格式 `YYYY-MM-DDTHH:mm:ss+08:00`
4. **数组限制**: monitoring.json数组最多保存100条历史记录
5. **手动采集**: 支持单个商品手动采集，避免批量采集的复杂性
6. **今日状态检查**: 自动检查每个商品的今日采集状态，避免重复采集
7. **错误处理**: 采集失败的任务会标记为失败状态，支持重新采集
8. **插件依赖**: 需要Chrome插件在浏览器中运行才能完成采集
9. **通信机制**: 支持localStorage和postMessage两种通信方式
10. **超时保护**: 每个任务有20秒超时限制，每3秒检查一次结果
11. **主题适配**: 悬浮按钮会根据系统主题自动调整颜色
12. **自动刷新**: 采集完成后自动刷新状态，无需手动操作

## 插件通信协议

### 采集请求格式
HTML页面向插件发送采集请求：
```javascript
localStorage.setItem('collectionRequest', JSON.stringify({
    action: 'startCollection',
    taskId: 0,
    goodsId: '123456789012',
    url: 'https://example.com/product',
    timestamp: '2025-01-20T10:30:00.000Z'
}));
```

### 采集结果格式
插件返回采集结果：
```javascript
localStorage.setItem('collectionResult_0', JSON.stringify({
    success: true,
    collectedData: {
        goodsData: {
            goodsSold: 1054,
            goodsPromoPrice: 1.89,
            goodsTitle: '商品标题',
            goodsRating: 4.5,
            goodsReviews: 128
        },
        storeData: {
            storeSold: 600000,
            storeFollowers: 1019,
            storeItemsNum: 53,
            storeRating: 4.6,
            storeName: '店铺名称'
        }
    }
}));
```

### 错误处理
采集失败时返回：
```javascript
localStorage.setItem('collectionResult_0', JSON.stringify({
    success: false,
    error: '采集失败原因'
}));
```

### 插件实现要求
插件需要监听localStorage变化并执行采集：
```javascript
window.addEventListener('storage', (e) => {
    if (e.key === 'collectionRequest') {
        const request = JSON.parse(e.newValue);
        // 执行采集逻辑
        performCollection(request).then(result => {
            localStorage.setItem('collectionResult_' + request.taskId, JSON.stringify(result));
        });
    }
});
```