# 采集字段说明

## 实现逻辑

### 1. 图片收集机制
- **即时收集**: 页面加载时立即扫描所有`<img>`标签，收集HTTP开头的图片URL
- **动态监听**: 使用`MutationObserver`监听DOM变化，捕获动态加载的图片
- **滚动触发**: 监听页面滚动事件，触发懒加载图片的收集
- **加载监听**: 监听图片`load`事件，确保所有图片都被收集

### 2. 图片源整合
- **主图片**: 从`window.rawData`中的`mainImages`字段提取商品主图
- **SKU图片**: 从商品SKU列表中的`skuPic`字段提取变体图片
- **页面图片**: 收集页面中所有可见的图片元素
- **去重处理**: 使用Set数据结构自动去除重复的图片URL

### 3. 图片筛选机制
- **尺寸检测**: 异步加载图片获取真实尺寸信息
- **范围筛选**: 设置最小/最大尺寸阈值过滤图片
- **目标尺寸**: 识别接近目标尺寸(800x800px)的高质量图片
- **容错处理**: 对加载失败的图片进行错误计数和日志记录

### 4. 数据存储结构
- **商品信息**: 存储基础商品数据和图片URL列表
- **媒体信息**: 存储图片详细尺寸、类型和筛选结果
- **监控数据**: 存储商品监控相关的图片引用

## 采集字段说明

### goods-{goodsId}-{version}.json (商品信息文件)
```json
{
  "goodsId": "商品ID",
  "itemId": "商品编号", 
  "goodsCat1": "一级分类",
  "goodsCat2": "二级分类",
  "goodsCat3": "三级分类",
  "goodsTitleEn": "英文标题",
  "goodsTitleCn": "中文标题",
  "skuList": [
    {
      "skuId": "SKU ID",
      "skuName": "SKU名称",
      "skuPic": "SKU图片URL",
      "goodsPromoPrice": "促销价格",
      "goodsNormalPrice": "正常价格"
    }
  ],
  "goodsPropertyInfo": {
    "材质": "商品材质",
    "颜色": "商品颜色",
    "类型": "商品类型",
    "商品编号": "商品编号",
    "产地": "生产产地"
  },
  "collectTime": "采集时间",
  "collectUrl": "采集页面URL"
}
```

### media-{goodsId}-{version}.json (媒体文件)
```json
{
  "goodsId": "商品ID",
  "media": [
    {
      "url": "图片/视频URL",
      "width": "宽度(像素)",
      "height": "高度(像素)", 
      "isTargetSize": "是否为目标尺寸",
      "type": "类型(image/video)",
      "path": "本地存储路径(初始为null)"
    }
  ]
}
```

### monitoring-{goodsId}-{version}.json (监控数据文件)
```json
{
  "goodsId": "商品ID",
  "listingDate": "上架日期",
  "collectTime": "采集时间",
  "goodsSold": "销量",
  "goodsCat1": "一级分类",
  "goodsCat2": "二级分类", 
  "goodsCat3": "三级分类",
  "skuList": [
    {
      "skuId": "SKU ID",
      "skuName": "SKU名称",
      "skuPic": "SKU图片URL",
      "goodsPromoPrice": "促销价格"
    }
  ],
  "storeId": "店铺ID",
  "storeName": "店铺名称",
  "storeData": {
    "storeRating": "店铺评分",
    "storeSold": "店铺销量",
    "storeFollowers": "店铺关注数",
    "storeltemsNum": "店铺商品数",
    "storeStartYear": "店铺经营年限"
  }
}
```

## 技术特点

### 1. 性能优化
- **异步处理**: 图片尺寸检测采用异步加载，避免阻塞主线程
- **批量处理**: 支持批量检测大量图片，提供进度反馈
- **内存管理**: 使用Set去重，避免重复图片占用内存

### 2. 容错机制
- **跨域处理**: 设置`crossOrigin`属性处理跨域图片
- **错误捕获**: 对加载失败的图片进行错误统计
- **超时处理**: 避免单个图片加载时间过长影响整体性能

### 3. 数据完整性
- **多源整合**: 从多个数据源收集图片，确保不遗漏
- **尺寸验证**: 获取真实图片尺寸，便于后续筛选和处理
- **类型识别**: 区分图片和视频，支持多媒体内容采集
